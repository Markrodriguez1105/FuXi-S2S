services:
  weather_service:
    build:
      context: ./weather_service
      dockerfile: Dockerfile
    container_name: fuxi-weather-service
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      - PORT=5002
      - MONGO_DB_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}
      - MONGO_DB=${MONGO_DB}
      - MODEL_SERVICE_URL=http://fuxis2s_model:8002
      - DEBUG=false
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fuxi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  fuxis2s_model:
    build:
      context: .
      dockerfile: fuxis2s_model/Dockerfile
    container_name: fuxi-model-service
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - MONGO_DB_URI=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@${MONGO_HOST}:${MONGO_PORT}
      - MONGO_DB=${MONGO_DB}
      - MODEL_PATH=/app/model/fuxi_s2s.onnx
      - DATA_DIR=/app/data
      - OUTPUT_DIR=/app/output
      - DEVICE=cuda
      - DEFAULT_MEMBERS=11
      - DEFAULT_STEPS=42
      - DEFAULT_STATION=Pacol, Naga City
      - CROP_LAT=13.58
      - CROP_LON=123.28
      - CROP_RADIUS=10.0
      - CDS_API_URL=${CDS_API_URL}
      - CDS_API_KEY=${CDS_API_KEY}
    volumes:
      # Model file
      - ./model:/app/model:ro
      # Data directories
      - ./data:/app/data
      # Output directory
      - ./output:/app/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fuxi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mongodb:
    image: mongodb/mongodb-community-server:7.0-ubi8
    container_name: fuxi-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_DB}
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - fuxi-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  mongodb_data:
    driver: local

networks:
  fuxi-network:
    driver: bridge
